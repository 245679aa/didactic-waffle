<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>验证码获取工具</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body { background: #0b1020; color: #e7eaf6; margin: 0; min-height: 100vh; display: grid; place-items: center; }
    。card { width: min(680px, 92vw); background: #121836; border: 1px solid #2a335b; border-radius: 16px; padding: 24px 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 16px; font-size: 20px; }
    p.hint { margin: 8px 0 18px; color: #a9b2d6; font-size: 14px; }
    。row { display: flex; gap: 10px; }
    input[type="email"] {
      flex: 1; padding: 12px 14px; border-radius: 12px; border: 1px solid #2a335b; background: #0f1430; color: #e7eaf6;
      outline: none; font-size: 15px;
    }
    input[type="email"]::placeholder { color: #6e78a5; }
    button {
      padding: 12px 16px; border-radius: 12px; border: 0; cursor: pointer; font-size: 15px; font-weight: 600;
      background: #5562ff; color: white; transition: transform .04s ease, filter .2s ease;
    }
    button:active { transform: translateY(1px); }
    。result {
      margin-top: 16px; border-radius: 12px; padding: 14px; background: #0f1430; border: 1px solid #2a335b;
      font-size: 14px; line-height: 1.6;
      word-break: break-all;
    }
    。code {
      display: inline-block; margin-top: 4px; font-size: 28px; font-weight: 800; letter-spacing: 2px; background: #0b1020;
      padding: 6px 10px; border-radius: 10px; border: 1px dashed #5562ff;
    }
    。muted { color: #92a0d4; }
    。err { color: #ffb3bd; }
    。ok { color: #7bffb2; }
    。small { font-size: 12px; margin-top: 10px; color: #92a0d4; }
  </style>
</head>
<body>
  <div class="card">
    <h1>获取邮箱验证码</h1>
    <p class="hint">输入收件地址，系统将从最新邮件中提取 4–8 位数字验证码。</p>
    <div class="row">
      <input id="email" type="email" placeholder="例如：foo@bar.com" autocomplete="email" />
      <button id="btn">获取验证码</button>
    </div>
    <div id="result" class="result muted">等待输入…</div>
    <div class="small">温馨提示：如果验证码错误请刷新页面然后再获取；仍不行请稍等片刻再发送验证码。</div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const emailEl = $("#email");
    const btn = $("#btn");
    const resultEl = $("#result");

    function show(msg, cls = "muted") {
      resultEl.className = "result " + cls;
      resultEl.innerHTML = msg;
    }

    async function fetchCode(email) {
      const qs = new URLSearchParams({ email });
      const url = `/api/code?${qs.toString()}`; // 确保与你的部署路径一致
      const resp = await fetch(url, { method: "GET" });
      const data = await resp.json().catch(() => ({}));
      return { ok: resp.ok && data?.ok, data };
    }

    btn.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      if (!email) return show("请输入邮箱地址。", "err");

      btn.disabled = true;
      btn.textContent = "获取中…";
      show(`正在查询最新邮件并提取验证码，请稍候…`, "muted");

      try {
        const { ok, data } = await fetchCode(email);
        if (ok && data?.code) {
          const subject = data.subject || "(无标题)";
          const dateBeijing = data.date_beijing || data.date_utc || "";
          show(
            `邮箱：<b>${data.email}</b><br/>
             标题：<b>${subject}</b><br/>
             时间（北京时间）：<b>${dateBeijing}</b><br/>
             邮件ID：<b>${data.mail_id}</b><br/>
             验证码： <span class="code">${data.code}</span>`,
            "ok"
          );
        } else {
          const reason = data?.error || "未找到验证码或邮箱没有新邮件";
          const subject = data?.subject ? `<br/>标题：<b>${data.subject}</b>` : "";
          const dateBeijing = data?.date_beijing || data?.date_utc || "";
          const timeLine = dateBeijing ? `<br/>时间（北京时间）：<b>${dateBeijing}</b>` : "";
          show(`获取失败：${reason}${subject}${timeLine}`, "err");
        }
      } catch (e) {
        show("请求异常，请稍后再试。", "err");
      } finally {
        btn.disabled = false;
        btn.textContent = "获取验证码";
      }
    });
  </script>
</body>
</html>
